// ============================
// Prisma Schema - ShiftMaster MVP
// ============================

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================
// Enums - FROZEN CONTRACT v1.0.0
// ============================
// ‚ö†Ô∏è  These enum values are immutable and shared with:
//    - Backend API (domain/shared/enums.ts)
//    - Web Frontend
//    - Mobile App
//    - OpenAPI/Swagger
//
// üîí NEVER rename enum values
// ‚úÖ  New values may be added
//
// Version: 1.0.0
// Last Updated: 2026-01-31
// ============================

// System-level user roles for authentication and authorization
enum UserRole {
  worker // Regular shift worker
  site_manager // Site manager with site-level permissions
  safety_officer // Safety compliance officer
  admin // System administrator with full access
}

// Specialized worker roles and certifications (workers can have multiple)
enum JobRole {
  crane_operator // Licensed crane operator
  safety_assistant // Safety support on site
  signalman // Crane signaling/spotting
  site_manager // On-site management role
  safety_officer // Safety compliance officer
  general_worker // General construction worker
}

// Shift lifecycle states with defined transitions
// Flow: draft ‚Üí broadcasted ‚Üí assigned ‚Üí completed
//       Any state can transition to cancelled
enum ShiftState {
  draft // Created but not visible to workers
  broadcasted // Posted and open for applications
  assigned // Worker assigned to shift
  completed // Work finished, awaiting approval
  cancelled // Cancelled by manager (terminal)
}

// Shift classification for billing and prioritization
enum ShiftType {
  regular // Standard scheduled shift
  overtime // Extended hours or weekend shift
  emergency // Urgent unplanned shift
}

// Application workflow states
// Flow: applied ‚Üí pending ‚Üí approved/rejected
//       applied can also ‚Üí withdrawn
enum ApplicationState {
  applied // Initial worker application
  pending // Under manager review
  approved // Application accepted (terminal)
  rejected // Application declined (terminal)
  withdrawn // Worker cancelled application (terminal)
}

// System actions logged for compliance and audit trail
enum AuditAction {
  // Worker actions
  worker_created
  worker_role_updated
  worker_cert_updated

  // Shift lifecycle
  shift_created
  shift_updated
  shift_deleted
  shift_broadcasted
  shift_assigned
  shift_approved
  shift_completed
  shift_cancelled
  shift_override_edit

  // Application workflow
  shift_applied
  shift_application_approved
  shift_application_rejected
  shift_application_withdrawn

  // Reporting
  pdf_generated

  // Security
  login_success
  login_failed
  permissions_changed
}

// Entity types for audit log categorization
enum AuditEntityType {
  worker
  shift
  application
  report
  auth
}

// Push notification and alert categories
enum NotificationType {
  shift_broadcasted // New shift posted
  application_received // Manager got application
  application_approved // Worker's application approved
  application_rejected // Worker's application rejected
  hours_submitted // Worker submitted hours
  hours_approved // Manager approved hours
  shift_reminder // Upcoming shift reminder
  shift_cancelled // Shift was cancelled
}

// ============================
// Worker
// ============================
model Worker {
  id            String   @id @default(uuid())
  name          String
  email         String   @unique
  phone         String
  password      String? // hashed password for authentication
  phoneVerified Boolean  @default(false)
  role          UserRole @default(worker)

  // Worker-specific fields
  roles              JobRole[]
  certifications     String[]
  availabilityStatus Boolean   @default(true)

  // optional residence for future distance logic
  residenceLocation String?

  // Relations
  shifts         Shift[]            @relation("WorkerShifts")
  approvedShifts Shift[]            @relation("ApprovedBy")
  auditLogs      AuditLog[]
  notifications  Notification[]
  managedSites   Site[]             @relation("SiteManager")
  workerRates    WorkerRate[]
  applications   ShiftApplication[]

  createdAt DateTime @default(now())
}

// ============================
// Site
// ============================
model Site {
  id      String  @id @default(uuid())
  name    String
  address String?

  managerId String
  manager   Worker @relation("SiteManager", fields: [managerId], references: [id])

  cranes    Crane[]
  shifts    Shift[]
  siteRates SiteRate[]

  createdAt DateTime @default(now())
}

// ============================
// Crane
// ============================
model Crane {
  id          String @id @default(uuid())
  craneNumber String
  siteId      String
  site        Site   @relation(fields: [siteId], references: [id])

  shifts Shift[]

  createdAt DateTime @default(now())
}

// ============================
// Shift
// ============================
model Shift {
  id String @id @default(uuid())

  workerId String
  worker   Worker @relation("WorkerShifts", fields: [workerId], references: [id])

  siteId String
  site   Site   @relation(fields: [siteId], references: [id])

  date            String // YYYY-MM-DD format for the shift date
  startTime       DateTime?
  endTime         DateTime?
  actualStartTime DateTime?
  actualEndTime   DateTime?
  breakMinutes    Int?
  totalHours      Decimal?  @db.Decimal(4, 2)
  hours           Decimal   @db.Decimal(4, 2)

  roleRequired JobRole // REQUIRED: The job role for this shift
  equipmentId  String? // OPTIONAL: Equipment ID (only for crane_operator or signalman)

  operatorRate Decimal @db.Decimal(8, 2) // default cost
  siteRate     Decimal @db.Decimal(8, 2) // default revenue

  // Optional overrides for emergency / special cases
  overrideOperatorRate Decimal? @db.Decimal(8, 2)
  overrideSiteRate     Decimal? @db.Decimal(8, 2)

  state        ShiftState @default(assigned) // Track shift state through workflow
  shiftType    ShiftType  @default(regular) // Shift classification for billing
  approved     Boolean    @default(false)
  approvedById String?
  approvedBy   Worker?    @relation("ApprovedBy", fields: [approvedById], references: [id])
  approvedAt   DateTime?
  locked       Boolean    @default(false)
  // When true, allows a worker to edit/delete the shift after approval
  overrideEdit Boolean    @default(false)

  craneId String? // DEPRECATED: kept for backward compatibility
  crane   Crane?  @relation(fields: [craneId], references: [id])

  // Broadcast and applications relation
  applications  ShiftApplication[]
  notifications Notification[]

  createdAt DateTime @default(now())
}

// ============================
// WorkerRate
// ============================
model WorkerRate {
  id       String @id @default(uuid())
  workerId String
  worker   Worker @relation(fields: [workerId], references: [id])

  hourlyRate Decimal   @db.Decimal(8, 2)
  validFrom  DateTime
  validTo    DateTime?

  createdAt DateTime @default(now())
}

// ============================
// SiteRate
// ============================
model SiteRate {
  id     String @id @default(uuid())
  siteId String
  site   Site   @relation(fields: [siteId], references: [id])

  hourlyRate Decimal   @db.Decimal(8, 2)
  validFrom  DateTime
  validTo    DateTime?

  createdAt DateTime @default(now())
}

// ============================
// OTP (One-Time Password for phone verification)
// ============================
model OTP {
  id        String   @id @default(uuid())
  phone     String
  code      String // 6-digit numeric code
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// ============================
// ShiftApplication (Broadcast matching)
// ============================
model ShiftApplication {
  id      String @id @default(uuid())
  shiftId String
  shift   Shift  @relation(fields: [shiftId], references: [id], onDelete: Cascade)

  workerId String
  worker   Worker @relation(fields: [workerId], references: [id], onDelete: Cascade)

  status    ApplicationState @default(applied)
  appliedAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  createdAt DateTime @default(now())

  @@unique([shiftId, workerId]) // Prevent duplicate applications
}

// ============================
// AuditLog (Immutable compliance trail)
// ============================
model AuditLog {
  id         String          @id @default(uuid())
  actorId    String
  actor      Worker          @relation(fields: [actorId], references: [id], onDelete: Cascade)
  action     AuditAction
  entityType AuditEntityType
  entityId   String
  metadata   Json?
  ipAddress  String?
  userAgent  String?
  timestamp  DateTime        @default(now())
  createdAt  DateTime        @default(now())

  @@index([actorId])
  @@index([entityType, entityId])
  @@index([timestamp])
}

// ============================
// Notification (Worker inbox)
// ============================
model Notification {
  id       String @id @default(uuid())
  workerId String
  worker   Worker @relation(fields: [workerId], references: [id], onDelete: Cascade)

  shiftId String? // nullable for non-shift notifications
  shift   Shift?  @relation(fields: [shiftId], references: [id], onDelete: SetNull)

  title     String
  message   String
  type      NotificationType
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@index([workerId, createdAt])
  @@index([workerId, isRead])
}
