// ============================
// Prisma Schema - ShiftMaster MVP
// ============================

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================
// Enums
// ============================
enum Role {
  OPERATOR
  SITE_MANAGER
  PROJECT_MANAGER
  COMPANY_ADMIN
}

enum JobRole {
  crane_operator
  safety_assistant
  signalman
  site_manager
  safety_officer
  general_worker
}

enum ShiftState {
  assigned
  broadcasted
  applied
  pending_approval
  completed
}

// ============================
// Worker
// ============================
model Worker {
  id              String   @id @default(uuid())
  name            String
  email           String   @unique
  phone           String
  password        String?  // hashed password for authentication
  phoneVerified   Boolean  @default(false)
  role            Role     @default(OPERATOR)

  // Worker-specific fields
  roles           JobRole[]
  certifications  String[]
  availabilityStatus Boolean @default(true)

  // optional residence for future distance logic
  residenceLocation String?

  // Relations
  shifts        Shift[]        @relation("WorkerShifts")
  approvedShifts Shift[]       @relation("ApprovedBy")
  managedSites  Site[]         @relation("SiteManager")
  workerRates   WorkerRate[]

  createdAt DateTime @default(now())
}

// ============================
// Site
// ============================
model Site {
  id        String   @id @default(uuid())
  name      String
  address   String?

  managerId String
  manager   Worker    @relation("SiteManager", fields: [managerId], references: [id])

  cranes    Crane[]
  shifts    Shift[]
  siteRates SiteRate[]

  createdAt DateTime @default(now())
}

// ============================
// Crane
// ============================
model Crane {
  id          String @id @default(uuid())
  craneNumber String
  siteId      String
  site        Site   @relation(fields: [siteId], references: [id])

  shifts Shift[]

  createdAt DateTime @default(now())
}

// ============================
// Shift
// ============================
model Shift {
  id String @id @default(uuid())

  workerId String
  worker   Worker @relation("WorkerShifts", fields: [workerId], references: [id])

  siteId String
  site   Site   @relation(fields: [siteId], references: [id])

  date          String   // YYYY-MM-DD format for the shift date
  startTime     DateTime?
  endTime       DateTime?
  hours         Decimal  @db.Decimal(4, 2)

  roleRequired  JobRole  // REQUIRED: The job role for this shift
  equipmentId   String?  // OPTIONAL: Equipment ID (only for crane_operator or signalman)

  operatorRate Decimal @db.Decimal(8, 2) // default cost
  siteRate     Decimal @db.Decimal(8, 2) // default revenue

  // Optional overrides for emergency / special cases
  overrideOperatorRate Decimal? @db.Decimal(8, 2)
  overrideSiteRate     Decimal? @db.Decimal(8, 2)

  state         ShiftState @default(assigned) // Track shift state through workflow
  approved      Boolean    @default(false)
  approvedById  String?
  approvedBy    Worker?    @relation("ApprovedBy", fields: [approvedById], references: [id])
  // When true, allows a worker to edit/delete the shift after approval
  overrideEdit  Boolean    @default(false)

  craneId       String?  // DEPRECATED: kept for backward compatibility
  crane         Crane?   @relation(fields: [craneId], references: [id])

  createdAt DateTime @default(now())
}

// ============================
// WorkerRate
// ============================
model WorkerRate {
  id       String   @id @default(uuid())
  workerId String
  worker   Worker   @relation(fields: [workerId], references: [id])

  hourlyRate Decimal  @db.Decimal(8, 2)
  validFrom  DateTime
  validTo    DateTime?

  createdAt DateTime @default(now())
}

// ============================
// SiteRate
// ============================
model SiteRate {
  id        String   @id @default(uuid())
  siteId    String
  site      Site     @relation(fields: [siteId], references: [id])

  hourlyRate Decimal  @db.Decimal(8, 2)
  validFrom  DateTime
  validTo    DateTime?

  createdAt DateTime @default(now())
}

// ============================
// OTP (One-Time Password for phone verification)
// ============================
model OTP {
  id        String   @id @default(uuid())
  phone     String
  code      String   // 6-digit numeric code
  expiresAt DateTime
  createdAt DateTime @default(now())
}
